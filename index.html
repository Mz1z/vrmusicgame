<html>
  <head>
    <meta charset="utf-8">
    <!--Libraries & external scripts Import-->
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <script src="libs/aframe-physics-system.min.js"></script>

    <!-- js start -->
    
<script type="text/javascript">
  // json谱面格式
  var song = [
    {1000: ['c','v']},
    {1200: ['v']},
  ];

  // 全局变量游戏状态
  var game_status = 0; // 0表示没开，1表示开了
  // 计分
  var allhit = song.length;
  var perfect = 0;
  var good = 0;
  var miss = 0;

  // 现价音符箭头
  function add_music_char(_c){
    var x_start = -2;
      var y = 0;
      var z = -4.3;
      var _rotation = ["90 0 0", "90 0 180", "180 90 90", "180 90 270"];
      var i = _c;
    var sceneEl = document.querySelector('a-scene');
    var el = document.createElement('a-entity');
        el.setAttribute('gltf-model', '#arr');
        el.setAttribute('scale', '25 25 25');
        el.setAttribute('position', (x_start+i*1.3)+" "+y+" "+z);
        el.setAttribute('rotation', _rotation[i]);
        el.setAttribute('static-body','');
        el.setAttribute('color', "tomato");
        el.setAttribute('animation', "property: position; to: "+(x_start+i*1.3)+" 5 -4.3; dur: 2000; easing: linear; loop: false");
        // 绑定事件测试
        el.addEventListener('animationcomplete', function (event) {
          console.log('end animation');
          // 清除这个东西
          sceneEl.removeChild(el);
        });


        
        // 向音符队列中加入音符
        song_chars.push(el);

    sceneEl.appendChild(el);

  }

  // 初始化游戏音符队列
  var song_chars = [];
  var up_chars = [];   // 顶部的方向键

  // 初始化游戏，添加组件
  window.onload = function init_game(){
      console.log('init');
      // 添加上方箭头
      var x_start = -2;
      var y = 4.2;
      var z = -4.3;
      //角度记录 90 0 0 左，90 0 180右，180 90 90 上， 180 90 270 下
      var _rotation = ["90 0 0", "90 0 180", "180 90 90", "180 90 270"];
      var sceneEl = document.querySelector('a-scene');
      for (let i=0; i<4; i ++){
        var el = document.createElement('a-entity');
        el.setAttribute('gltf-model', '#arr');
        el.setAttribute('scale', '25 25 25');
        el.setAttribute('position', (x_start+i*1.3)+" "+y+" "+z);
        el.setAttribute('rotation', _rotation[i]);
        // 尝试绑定动画 打击时的动画
        el.setAttribute('animation__hit', "property: scale; to:35 35 35; dur:180; easing: linear;startEvents:hit");
        
        el.setAttribute('static-body','');
        sceneEl.appendChild(el);
        up_chars.push(el);
        // 绑定还原大小的事件
        up_chars[i].addEventListener('animationcomplete', function (event) {
            // 还原初始大小
            up_chars[i].setAttribute('scale', '25 25 25');
        });

      }

      // 初始化音符队列并开始游戏
      // 直接全部整计时器

      
  }

AFRAME.registerComponent('log', {
  schema: {type: 'string'},

  init: function () {
    var stringToLog = this.data;
    // 增加键盘监听 
    console.log(stringToLog);
    window.addEventListener('keydown',function(e){
        // cvbn作为打击按键
        // console.log(e);
        if (e.key == "c"){
            console.log('c');
            up_chars[0].emit("hit");   // 发送自定义事件
            // 判断有没有打中
            
        }else if (e.key == "v"){
            console.log('v');
            up_chars[1].emit("hit");   // 发送自定义事件
        }else if (e.key == "b"){
            console.log('b');
            up_chars[2].emit("hit");   // 发送自定义事件
        }else if (e.key == "n"){
            console.log('n');
            up_chars[3].emit("hit");   // 发送自定义事件
        }else if (e.key == "0"){
            console.log('start!');
        }
        // 几个测试按键
        else if (e.key == "1"){
            add_music_char(0);
        }else if (e.key == "2"){
            add_music_char(1);
        }else if (e.key == "3"){
            add_music_char(2);
        }else if (e.key == "4"){
            add_music_char(3);
        }
    }); 
  }

});



</script>
  </head>
  <body>

    <!-- <a-scene physics stats> -->
      <a-scene physics>

<!--Entity to add background noise-->
      <a-entity sound="src: url(assets/audio/smz.mp3); autoplay: true; loop:true; distanceModel:linear">
      </a-entity>

<!-- 动画测试 -->
      <!-- <a-box scale="0.5 0.5 0.5" position="-2 0 -4" animation="property: position; to: -2 4.5 -4; dur: 3000; easing: linear; loop: true" color="tomato"></a-box> -->


<!-- 显示文字 -->
<a-text
    id="start-text"
    value="Press '0' to Start"
    color="#BBB"
    position="-3 3 -6"
    scale="5 5 5"
    font="mozillavr"
  ></a-text>

      <!-- 加载模型 -->
      <a-assets>
         <a-asset-item id="castle" src="assets/scene.gltf"></a-asset-item>
         <a-asset-item id="arr" src="assets/left.gltf"></a-asset-item>

         <a-asset-item id="dance" src="assets/donghua.gltf"></a-asset-item>
      </a-assets>

      <a-entity gltf-model="#dance" scale="1.6 1.6 1.6" position="0 0 -4" rotation="0 0 0" animation-mixer></a-entity>
      <a-entity gltf-model="#castle" scale="0.1 0.1 0.1" position="-1.5 2.5 -4" rotation="0 45 0" dynamic-body></a-entity>
      <!-- <a-entity gltf-model="#arr" scale="20 20 20" position="-1 2 -4" rotation="90 0 0" static-body></a-entity> -->

      <!-- 舞台 -->
      <a-plane position="0 0 -5" rotation="-90 0 0" width="5" height="4" color="#7BC8A4" static-body></a-plane>
      <a-sky color="#ECECEC"></a-sky>

      <a-entity log="hello"></a-entity>

<!-- 相机，还没弄好 -->
      <!-- <a-entity camera look-controls wasd-controls position="0 1 0">
        <a-entity cursor="fuse: true; fuseTimeout: 500"
                  position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                  material="color: black; shader: flat">
        </a-entity>
      </a-entity> -->
        




    </a-scene>

    <!-- aframe end -->








  </body>
</html>